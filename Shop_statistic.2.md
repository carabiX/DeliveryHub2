## Статистика заказов по курьерам

## /Shop_statistic

### Описание 

Назначение сервиса - создание статистик по различным показателям количества заказов и количеству курьеров на смену по часам

### Модели данных

**Журнал запуска статистики** **(log) в Timer2**

| Поле    | Тип      | Описание                               | Пример                                 |
| ------- | -------- | -------------------------------------- | -------------------------------------- |
| shopId  | uuid     | Уникальный идентификатор пункта выдачи | "72637ff2-443f-11e7-80e5-005056ae40e3" |
| lastRun | datetime | Время последнего запуска               | 2017-05-29T11:58:59.000Z               |
| nextRun | datetime | Время следующего запуска               | 2017-05-29T11:58:59.000Z               |

**Статистика по заказам и курьерам пункта выдачи**

| Поле            | Тип       | Описание                                                     | Пример                                 |
| --------------- | --------- | ------------------------------------------------------------ | -------------------------------------- |
| id              | uuid      | Уникальный идентификатор                                     | “37829de0-4459-11e7-80e3-005056ae0185" |
| areaId          | uuid      | Уникальный идентификатор локации                             | “37829de0-4459-11e7-80e3-005056ae0185" |
| shopId          | uuid      | Уникальный идентификатор пункта выдачи                       | “37829de0-4459-11e7-80e3-005056ae0185" |
| dayOfWeek       | char(255) | День недели                                                  | monday                                 |
| hour            | int       | Конкретный час дня недели                                    | 01                                     |
| normOrdersCount | int       | Нормативное количество заказов на конкретный час             | 12                                     |
| normAgentsCount | int       | Нормативное количество потребности в курьерах на конкретный час | 12                                     |
| statOrdersCount | int       | Статистика количества  выполненных заказов на конкретный час | 12                                     |
| statAgentsCount | int       | Статистика количества курьеров на конкретный час по выполненным заказам | 8                                      |
| changeNormAt    | datetime  | Дата внесения нормативов                                     | 2017-05-29T11:58:59.000Z               |
| statAt          | datetime  | Дата записи статистики                                       | 2017-05-29T11:58:59.000Z               |

### API

**Получение списка статистик по пункту выдачи**



GET /shop_statstic{?shopid} 

**URI Parameters** 

**shop_id**  Уникальный идентификатор пункта выдачи **Example:** 23601e27-c067-4c98-91f9-2f52b07a2215

**Response**

```
[{
  "id": "37829de0-4459-11e7-80e3-005056ae0185",
  "shopId": "50972ada-7f16-4e4d-b310-fcf51be43f7a",
  "areId": "50972ada-7f16-4e4d-b310-fcf51be43f7a",
  "statistics": {
    "hours": [{
      "hour": 11, 
      "normAgentsCount": 2,
      "normOrdersCount": 5,
      "statAgentsCount": 4,
      "statOrdersCount": 7
    }],
    "dayOfWeek": "monday"
  }
  "changeNormAt": "2017-05-29T12:28:53.000Z",
  "statAt": "2017-05-29T12:28:53.000Z",
}]
```

## График работы пункта выдачи

##  /**Shop_schedule**

**Описание** 

Сервис предназначен для формирования режима, графика работы пункта выдачи и курьера

### Модели данных

**Режим работы пункта выдачи** (schedule)

| Поле             | Тип       | Описание                                    | Пример                               |
| ---------------- | --------- | ------------------------------------------- | ------------------------------------ |
| id               | uuid      | Уникальный идентификатор                    | 72637ff2-443f-11e7-80e5-005056ae40e3 |
| shopId           | uuid      | Уникальный идентификатор пункта выдачи      | 72637ff2-443f-11e7-80e5-005056ae40e3 |
| dayOfWeek        | char(255) | День недели                                 | monday                               |
| workShift        | char(255) | Название смены                              | morning                              |
| workingHoursFrom | datetime  | Время начала работы                         | 2017-05-29T11:58:59.000Z             |
| workingHoursTo   | datetime  | Время завершения работы                     | 2017-05-29T11:58:59.000Z             |
| updateAt         | datetime  | Дата редактирования графика работы магазина | 2017-05-29T11:58:59.000Z             |

**График работы пункта выдачи** **по дням** (shopPlans)

| Поле             | Тип      | Описание                                         | Пример                               |
| ---------------- | -------- | ------------------------------------------------ | ------------------------------------ |
| id               | uuid     | Уникальный идентификатор                         | 37829de0-4459-11e7-80e3-005056ae0185 |
| shopId           | uuid     | Уникальный идентификатор пункта выдачи           | 72637ff2-443f-11e7-80e5-005056ae40e3 |
| date             | datetime | Дата работы пункта выдачи                        | 2017-06-17T21:00:00Z                 |
| planWorkingHours | num      | Плановое количество рабочих часов                | 9                                    |
| factWorkingHours | num      | Фактическое количество рабочих часов (по DONE)   | 8                                    |
| normAgentsCount  | num      | Количество агентов по нормативу                  | 6                                    |
| planAgentsCount  | num      | Количество агентов в графике                     | 6                                    |
| factAgentsCount  | num      | Фактическое количество агентов на день (по DONE) | 5                                    |

**Часы работы пункт выдачи**

| Поле            | Тип       | Описание                                          | Пример                               |
| --------------- | --------- | ------------------------------------------------- | ------------------------------------ |
| id              | uuid      | Уникальный идентификатор                          | 37829de0-4459-11e7-80e3-005056ae0185 |
| shopPlanId      | uuid      | Уникальный идентификатор графика работы           | 72637ff2-443f-11e7-80e5-005056ae40e3 |
| workShift       | char(255) | Название рабочей смены                            | morning                              |
| periodStart     | datetime  | Время начала смены                                | 2017-05-29T11:58:59.000Z             |
| periodEnd       | datetime  | Время конца смены                                 | 2017-05-29T11:58:59.000Z             |
| statOrdersCount | num       | Кол-во заказов статистика                         | 10                                   |
| factOrdersCount | num       | Фактическое количество заказов на смену (по DONE) | 8                                    |
| statAgentsCount | num       | Кол-во курьеров статистика                        | 3                                    |
| normOrdersCount | num       | Нормативное количество заказов на смену           | 12                                   |
| planAgentsCount | num       | Кол-во курьеров в графике                         | 5                                    |
| factAgentsCount | num       | Кол-во агентов факт (по DONE)                     | 6                                    |

**Курьеры на смене**

| Поле            | Тип      | Описание                                          | Пример                               |
| --------------- | -------- | ------------------------------------------------- | ------------------------------------ |
| id              | uuid     | Уникальный идентификатор                          | 37829de0-4459-11e7-80e3-005056ae0185 |
| shopPlanId      | uuid     | Уникальный идентификатор графика работы           | 72637ff2-443f-11e7-80e5-005056ae40e3 |
| agentId         | uuid     | Уникальный идентификатор агента                   | 37829de0-4459-11e7-80e3-005056ae0185 |
| periodStart     | datetime | Время начала смены                                | 2017-05-29T11:58:59.000Z             |
| periodEnd       | datetime | Время завершения смены                            | 2017-05-29T11:58:59.000Z             |
| factAgentsCount | num      | Фактическое количество заказов на смену (по DONE) | 5                                    |

### **API**



#### Получение режима работы пункта выдачи

GET /shop_schedule/{?shopIdList} 

GET /shop_schedule/{?shopId} 

**response**

Body

```
 [{
   "shedule": [{
     "workShifts": [{
       "workShift": "morning",
       "workingHoursFrom": "2017-05-29T12:28:53.000Z",
       "workingHoursTo": "2017-05-29T19:28:53.000Z"
     }],
     "dayOfWeek": "monday"
   }]
 }]

```



#### Изменение режима работы пункта выдачи

PUT /shop_schedule/{?scheduleId} 

**request** 

Body

```
"workShifts": [{
  "workShift": "morning",
  "workingHoursFrom": "2017-05-29T12:28:53.000Z",
  "workingHoursTo": "2017-05-29T19:28:53.000Z"
}],
"dayOfWeek": "monday"
```



#### Получение режима работы курьера





#### Получение графика работы пунктов выдачи по дням с фильтром

GET /SHOP_PLANS/{?merchantId,areaId,startAt, endAt}

**response**

Body

```
Response
  [{
    "id": "37829de0-4459-11e7-80e3-005056ae0185",
    "shopId": "50972ada-7f16-4e4d-b310-fcf51be43f7a",
    "date": "2017-05-29T12:28:53.000Z",
    "planWorkingHours": 4,
    "factWorkingHours": 5,
    "normAgentsCount": 8,
    "planAgentsCount": 6,
    "factAgentsCount": 2
  }]
```

#### **Получение графика работы пункта выдачи по дням**

GET /shop_plan_agent/{?shopId,startAt, endAt}

**response**

Body

```
Response
  [{
    "id": "37829de0-4459-11e7-80e3-005056ae0185",
    "shopId": "50972ada-7f16-4e4d-b310-fcf51be43f7a",
    "date": "2017-05-29T12:28:53.000Z",
    "planWorkingHours": 4,
    "factWorkingHours": 5,
    "normAgentsCount": 8,
    "planAgentsCount": 6,
    "factAgentsCount": 2
  }]
```

Получение графика работы пункта выдачи и агента

#### **Изменение нормативного количества агентов**

PUT /shop_statstic{id}/update-agents_stat_norm

**id **uuid (required) **Example:** 8b2c0888-4aff-11e7-80e5-005056ae40e3Уникальный идентификатор статистики пункта выдачиBody

```
{
  "id": "37829de0-4459-11e7-80e3-005056ae0185",
  "shopId": "72637ff2-443f-11e7-80e5-005056ae40e3",
   "date": "2017-06-17T21:00:00Z",
  "statistics": {
    "hours": [{
      "hour": 11,
      "normAgentsCount": 2,
    }],
    "dayOfWeek": "monday",
    "changeNormAt": "2017-05-29T12:28:53.000Z",
  }
```

#### Изменение нормативного количества заказов

PUT /shop_statstic{id}/update-orders_stat_norm

```
{
  "id": "37829de0-4459-11e7-80e3-005056ae0185",
  "shopId": "72637ff2-443f-11e7-80e5-005056ae40e3",
   "date": "2017-06-17T21:00:00Z",
  "statistics": {
    "hours": [{
      "hour": 11,
      "normOrdersCount": 2,
    }],
    "dayOfWeek": "monday",
    "changeNormAt": "2017-05-29T12:28:53.000Z",
    
  }
```

## Timer2 

**Описание**

Назначение сервиса - генерация статистики по количеству заказов и загруженности курьеров по сменам 

**Алгоритм работы**

1. Каждый день выбрать из SHOP_STAT.LOG все SHOP_ID требующий статистики NEXT_RUN <= текущему дню или пусто

2. Запускать /set_statistic

3. Рассчитывать след. Дату запуска статистика SHOP_STAT.LOG Записывать или создавать запись в журнал LAST_RUN = текущая датаNEXT_RUN = LAST_RUN + SETTING. STAT_SHOP_PERIOD INT * 30

   Генерация расписания работы магазина на след неделю(пт по умолчанию)

   1. Получить режим работы магазина. 
   2. Получить последний созданный день графика работы. 
   3. Создать график работы на SHOP_SETTING/SHOP_PLAN_PERIOD

## Алгоритм расчета статистики

1. Получить список заказов по пункту выдачи за определенный период

 2. Сгруппировать данные поshopId, DayOfWeek(deliveredAt), HourOfDay(deliveredAt)И получить значенияAVG(agentId) - среднее кол-во курьеров в час и день неделиAVG(ID) - - среднее кол-во заказов в час и день недели

    

